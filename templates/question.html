<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–æ–ø—Ä–æ—Å - –ß—Ç–æ? –ì–¥–µ? –ö–æ–≥–¥–∞?</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="logo">–ß–ì–ö</div>
        <h1>–ß—Ç–æ? –ì–¥–µ? –ö–æ–≥–¥–∞?</h1>
        
        <div class="card question-card">
            <div id="questionText" class="question-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...</div>
        </div>
        
        <div id="answerForm" class="card" style="display: none;">
            <h2>–í–∞—à –æ—Ç–≤–µ—Ç:</h2>
            <form id="submitAnswer">
                <div class="form-group">
                    <input type="text" id="answerInput" name="answer" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." required autocomplete="off">
                </div>
                <button type="submit" class="btn-primary" id="submitBtn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
            </form>
            <div id="timer" class="timer" style="display: none;"></div>
        </div>
        
        <div id="resultCard" class="card" style="display: none;">
            <div id="resultIcon" class="result-icon"></div>
            <h2 id="resultTitle"></h2>
            <p id="resultMessage"></p>
            <div id="successImageContainer" style="display: none;">
                <img id="successImage" alt="Success" style="max-width: 100%; height: auto; margin-top: 20px; border-radius: 10px;">
            </div>
        </div>
    </div>
    
    <script>
        const questionId = '{{ question_id }}';
        let clientId = localStorage.getItem('clientId');
        
        if (!clientId) {
            clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('clientId', clientId);
        }
        
        let timeoutTimer = null;
        
        async function loadQuestion() {
            try {
                const response = await fetch(`/api/question/${questionId}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('questionText').textContent = data.question;
                    document.getElementById('answerForm').style.display = 'block';
                } else {
                    document.getElementById('questionText').textContent = '–û—à–∏–±–∫–∞: ' + data.error;
                }
            } catch (error) {
                document.getElementById('questionText').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–∞';
            }
        }
        
        function startTimeout(seconds) {
            // Clear any existing timeout
            if (timeoutTimer) {
                clearTimeout(timeoutTimer);
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const answerInput = document.getElementById('answerInput');
            const timerDiv = document.getElementById('timer');
            
            submitBtn.disabled = true;
            answerInput.disabled = true;
            timerDiv.style.display = 'block';
            
            let remaining = seconds;
            
            function updateTimer() {
                if (remaining > 0) {
                    timerDiv.textContent = `–°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑: ${remaining} —Å–µ–∫`;
                    remaining--;
                    timeoutTimer = setTimeout(updateTimer, 1000);
                } else {
                    timerDiv.style.display = 'none';
                    submitBtn.disabled = false;
                    answerInput.disabled = false;
                    answerInput.focus();
                }
            }
            
            updateTimer();
        }
        
        document.getElementById('submitAnswer').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const answer = document.getElementById('answerInput').value;
            
            try {
                const response = await fetch(`/api/answer/${questionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answer, client_id: clientId })
                });
                
                const data = await response.json();
                
                const resultCard = document.getElementById('resultCard');
                const resultIcon = document.getElementById('resultIcon');
                const resultTitle = document.getElementById('resultTitle');
                const resultMessage = document.getElementById('resultMessage');
                const successImageContainer = document.getElementById('successImageContainer');
                const successImage = document.getElementById('successImage');
                
                if (data.correct) {
                    resultCard.className = 'card success-card';
                    resultIcon.textContent = 'üéâ';
                    resultTitle.textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!';
                    resultMessage.textContent = data.message;
                    
                    // Show success image if available
                    if (data.success_image) {
                        successImage.src = data.success_image;
                        successImageContainer.style.display = 'block';
                    } else {
                        successImageContainer.style.display = 'none';
                    }
                    
                    document.getElementById('answerForm').style.display = 'none';
                    resultCard.style.display = 'block';
                } else {
                    resultCard.className = 'card error-card';
                    resultIcon.textContent = '‚ùå';
                    resultTitle.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
                    resultMessage.textContent = data.message;
                    successImageContainer.style.display = 'none';
                    
                    resultCard.style.display = 'block';
                    
                    if (data.timeout) {
                        startTimeout(data.remaining_seconds);
                    } else {
                        startTimeout(30);
                    }
                    
                    document.getElementById('answerInput').value = '';
                    
                    // Hide result after 3 seconds
                    setTimeout(() => {
                        resultCard.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: ' + error.message);
            }
        });
        
        // Load question on page load
        loadQuestion();
    </script>
</body>
</html>
