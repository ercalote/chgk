<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–æ–ø—Ä–æ—Å - –ß—Ç–æ? –ì–¥–µ? –ö–æ–≥–¥–∞?</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="container">
        <div class="logo">–ß–ì–ö</div>
        <h1>–ß—Ç–æ? –ì–¥–µ? –ö–æ–≥–¥–∞?</h1>
        
        <div class="card question-card">
            <div id="questionText" class="question-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...</div>
        </div>
        
        <div id="answerForm" class="card" style="display: none;">
            <h2>–í–∞—à –æ—Ç–≤–µ—Ç:</h2>
            <form id="submitAnswer">
                <div class="form-group">
                    <input type="text" id="answerInput" name="answer" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." required autocomplete="off">
                </div>
                <button type="submit" class="btn-primary" id="submitBtn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
            </form>
            <div id="timer" class="timer" style="display: none;"></div>
        </div>
        
        <div id="resultCard" class="card" style="display: none;">
            <div id="resultIcon" class="result-icon"></div>
            <h2 id="resultTitle"></h2>
            <p id="resultMessage"></p>
            <div id="successImageContainer" style="display: none; margin-top: 20px;">
                <img id="successImage" alt="Success celebration image" style="max-width: 100%; height: auto; border-radius: 8px;">
            </div>
        </div>
    </div>
    
    <script>
        // Get question ID from URL - support both old format (?id=) and new format (/q/)
        const urlParams = new URLSearchParams(window.location.search);
        let questionId = urlParams.get('id');
        
        // If no question ID in query params, try to extract from path (for /q/<id> format)
        if (!questionId) {
            const pathMatch = window.location.pathname.match(/\/q\/([^\/]+)/);
            if (pathMatch) {
                questionId = pathMatch[1];
            }
        }
        
        let clientId = localStorage.getItem('clientId');
        
        if (!clientId) {
            clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
            localStorage.setItem('clientId', clientId);
        }
        
        let timeoutTimer = null;
        
        // localStorage helper functions for GitHub Pages mode
        function getQuestionsFromLocalStorage() {
            try {
                const data = localStorage.getItem('chgk_questions');
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error('Failed to parse questions from localStorage:', e);
                return {};
            }
        }
        
        async function loadQuestionsFromFile() {
            try {
                const response = await fetch('./questions.json');
                if (response.ok) {
                    const data = await response.json();
                    // Convert array to object for backward compatibility
                    if (Array.isArray(data)) {
                        const questionsObj = {};
                        data.forEach(q => {
                            if (q.id) {
                                questionsObj[q.id] = q;
                            }
                        });
                        return questionsObj;
                    }
                    // Legacy format support
                    return data.questions || {};
                }
            } catch (e) {
                console.log('Could not load questions.json:', e);
            }
            return {};
        }
        
        function getAttempts() {
            try {
                const data = localStorage.getItem('chgk_attempts');
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error('Failed to parse attempts from localStorage:', e);
                return {};
            }
        }
        
        function saveAttempts(attempts) {
            try {
                localStorage.setItem('chgk_attempts', JSON.stringify(attempts));
            } catch (e) {
                console.error('Failed to save attempts to localStorage:', e);
            }
        }
        
        async function loadQuestion() {
            if (!questionId) {
                document.getElementById('questionText').textContent = '–û—à–∏–±–∫–∞: ID –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ —É–∫–∞–∑–∞–Ω';
                return;
            }
            
            // Try API first
            try {
                const response = await fetch(`/api/question/${questionId}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('questionText').textContent = data.question;
                    document.getElementById('answerForm').style.display = 'block';
                    return;
                }
            } catch (error) {
                console.log('API not available, trying static questions.json or localStorage');
            }
            
            // Try loading from questions.json (GitHub Pages with pre-added questions)
            const fileQuestions = await loadQuestionsFromFile();
            
            if (fileQuestions[questionId]) {
                document.getElementById('questionText').textContent = fileQuestions[questionId].question;
                document.getElementById('answerForm').style.display = 'block';
                return;
            }
            
            // Fallback to localStorage (GitHub Pages with dynamically created questions)
            const localQuestions = getQuestionsFromLocalStorage();
            
            if (localQuestions[questionId]) {
                document.getElementById('questionText').textContent = localQuestions[questionId].question;
                document.getElementById('answerForm').style.display = 'block';
                return;
            }
            
            document.getElementById('questionText').textContent = '–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω';
        }
        
        function startTimeout(seconds) {
            // Clear any existing timeout
            if (timeoutTimer) {
                clearTimeout(timeoutTimer);
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const answerInput = document.getElementById('answerInput');
            const timerDiv = document.getElementById('timer');
            
            submitBtn.disabled = true;
            answerInput.disabled = true;
            timerDiv.style.display = 'block';
            
            let remaining = seconds;
            
            function updateTimer() {
                if (remaining > 0) {
                    timerDiv.textContent = `–°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑: ${remaining} —Å–µ–∫`;
                    remaining--;
                    timeoutTimer = setTimeout(updateTimer, 1000);
                } else {
                    timerDiv.style.display = 'none';
                    submitBtn.disabled = false;
                    answerInput.disabled = false;
                    answerInput.focus();
                }
            }
            
            updateTimer();
        }
        
        document.getElementById('submitAnswer').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const answer = document.getElementById('answerInput').value.trim();
            
            // Validate non-empty answer
            if (!answer) {
                return;
            }
            
            // Try API first
            try {
                const response = await fetch(`/api/answer/${questionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answer, client_id: clientId })
                });
                
                const data = await response.json();
                
                const resultCard = document.getElementById('resultCard');
                const resultIcon = document.getElementById('resultIcon');
                const resultTitle = document.getElementById('resultTitle');
                const resultMessage = document.getElementById('resultMessage');
                const successImageContainer = document.getElementById('successImageContainer');
                const successImage = document.getElementById('successImage');
                
                if (data.correct) {
                    resultCard.className = 'card success-card';
                    resultIcon.textContent = 'üéâ';
                    resultTitle.textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!';
                    resultMessage.textContent = data.message;
                    
                    // Show success image if available
                    if (data.success_image) {
                        // Reset image state
                        successImage.style.display = '';
                        successImage.src = data.success_image;
                        
                        // Handle image load success
                        successImage.onload = function() {
                            successImageContainer.style.display = 'block';
                        };
                        
                        // Handle image load errors
                        successImage.onerror = function() {
                            successImageContainer.style.display = 'none';
                        };
                    } else {
                        successImageContainer.style.display = 'none';
                    }
                    
                    document.getElementById('answerForm').style.display = 'none';
                    resultCard.style.display = 'block';
                } else {
                    resultCard.className = 'card error-card';
                    resultIcon.textContent = '‚ùå';
                    resultTitle.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
                    resultMessage.textContent = data.message;
                    successImageContainer.style.display = 'none';
                    
                    resultCard.style.display = 'block';
                    
                    if (data.timeout) {
                        startTimeout(data.remaining_seconds);
                    } else {
                        startTimeout(30);
                    }
                    
                    document.getElementById('answerInput').value = '';
                    
                    // Hide result after 3 seconds
                    setTimeout(() => {
                        resultCard.style.display = 'none';
                    }, 3000);
                }
                return;
            } catch (error) {
                console.log('API not available, using localStorage');
            }
            
            // Fallback to localStorage (GitHub Pages mode)
            const answerLower = answer.toLowerCase();
            
            // Try loading from questions.json first
            const fileQuestions = await loadQuestionsFromFile();
            let questions = fileQuestions;
            
            // If not found, try localStorage
            if (!questions[questionId]) {
                questions = getQuestionsFromLocalStorage();
            }
            
            const attempts = getAttempts();
            
            if (!questions[questionId]) {
                alert('–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // Check for timeout
            const attemptKey = `${questionId}:${clientId}`;
            
            if (attempts[attemptKey]) {
                const lastAttempt = new Date(attempts[attemptKey]);
                const now = new Date();
                const timeSince = (now - lastAttempt) / 1000; // seconds
                
                if (timeSince < 30) {
                    const remaining = Math.ceil(30 - timeSince);
                    
                    const resultCard = document.getElementById('resultCard');
                    const resultIcon = document.getElementById('resultIcon');
                    const resultTitle = document.getElementById('resultTitle');
                    const resultMessage = document.getElementById('resultMessage');
                    
                    resultCard.className = 'card error-card';
                    resultIcon.textContent = '‚è±Ô∏è';
                    resultTitle.textContent = '–ü–æ–¥–æ–∂–¥–∏—Ç–µ';
                    resultMessage.textContent = `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${remaining} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π`;
                    resultCard.style.display = 'block';
                    
                    startTimeout(remaining);
                    
                    // Hide result after 3 seconds
                    setTimeout(() => {
                        resultCard.style.display = 'none';
                    }, 3000);
                    
                    return;
                }
            }
            
            const correctAnswer = questions[questionId].answer.toLowerCase();
            const isCorrect = answerLower === correctAnswer;
            
            const resultCard = document.getElementById('resultCard');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            const successImageContainer = document.getElementById('successImageContainer');
            const successImage = document.getElementById('successImage');
            
            if (isCorrect) {
                resultCard.className = 'card success-card';
                resultIcon.textContent = 'üéâ';
                resultTitle.textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!';
                resultMessage.textContent = '–û—Ç–≤–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!';
                
                // Show success image if available
                if (questions[questionId].success_image) {
                    // Reset image state
                    successImage.style.display = '';
                    successImage.src = questions[questionId].success_image;
                    
                    // Handle image load success
                    successImage.onload = function() {
                        successImageContainer.style.display = 'block';
                    };
                    
                    // Handle image load errors
                    successImage.onerror = function() {
                        successImageContainer.style.display = 'none';
                    };
                } else {
                    successImageContainer.style.display = 'none';
                }
                
                document.getElementById('answerForm').style.display = 'none';
                resultCard.style.display = 'block';
                
                // Clear the attempt record
                if (attempts[attemptKey]) {
                    delete attempts[attemptKey];
                    saveAttempts(attempts);
                }
            } else {
                resultCard.className = 'card error-card';
                resultIcon.textContent = '‚ùå';
                resultTitle.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
                resultMessage.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥.';
                successImageContainer.style.display = 'none';
                
                resultCard.style.display = 'block';
                
                // Record failed attempt
                attempts[attemptKey] = new Date().toISOString();
                saveAttempts(attempts);
                
                startTimeout(30);
                
                document.getElementById('answerInput').value = '';
                
                // Hide result after 3 seconds
                setTimeout(() => {
                    resultCard.style.display = 'none';
                }, 3000);
            }
        });
        
        // Load question on page load
        loadQuestion();
    </script>
</body>
</html>
